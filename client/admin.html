<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - TechScope</title>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        admin: { DEFAULT: '#c0392b', hover: '#922b21' }
                    },
                    borderRadius: { '2xl': '1rem', '3xl': '1.25rem' }
                }
            }
        }
    </script>

    <!-- Shared Dashboard CSS (sidebar, layout, nav) -->
    <link rel="stylesheet" href="css/dashboard.css">
</head>

<body class="font-sans">
    <button class="mobile-toggle" id="mobileToggle">
        <i class="bi bi-list"></i>
    </button>

    <div class="dashboard-container">
        <!-- ── Sidebar ── -->
        <aside class="sidebar" id="sidebar">
            <a href="admin.html" class="brand">
                <i class="bi bi-shield-fill-check text-[#e74c3c]"></i>
                <span class="flex items-center gap-1.5 text-sm font-bold tracking-wide">
                    TechScope
                    <span
                        class="bg-[#c0392b] text-white text-[0.5rem] font-bold px-1.5 py-0.5 rounded-full whitespace-nowrap tracking-wider">
                        ADMIN
                    </span>
                </span>
            </a>

            <nav class="nav-links">
                <a href="#section-overview" class="nav-item active" id="nav-overview">
                    <i class="bi bi-grid-1x2"></i> Overview
                </a>
                <a href="#section-users" class="nav-item" id="nav-users">
                    <i class="bi bi-people"></i> Users
                </a>
                <a href="#section-products" class="nav-item" id="nav-products">
                    <i class="bi bi-box-seam"></i> Products
                </a>
                <a href="#section-alerts" class="nav-item" id="nav-alerts">
                    <i class="bi bi-bell"></i> Alerts
                </a>
                <a href="#section-activity" class="nav-item" id="nav-activity">
                    <i class="bi bi-clock-history"></i> Activity Log
                </a>
                <hr class="border-[#333] my-1">
                <a href="dashboard.html" class="nav-item">
                    <i class="bi bi-house-door"></i> User Dashboard
                </a>
            </nav>

            <div class="user-profile">
                <div class="user-avatar !bg-[#c0392b]" id="userAvatar">A</div>
                <div class="user-details">
                    <div class="user-name" id="displayUsername">Admin</div>
                    <div class="user-role">Administrator</div>
                </div>
                <a href="#" class="logout-btn" id="logoutBtn"
                    style="padding: 4px 8px; border: none; background: transparent;">
                    <i class="bi bi-box-arrow-right"></i>
                </a>
            </div>
        </aside>

        <!-- ── Main Content ── -->
        <main class="main-content">
            <!-- Header -->
            <div class="flex justify-between items-start mb-6 pb-3 border-b border-gray-200">
                <div>
                    <h1 class="text-2xl font-bold mb-0 flex items-center gap-2">
                        <i class="bi bi-shield-fill-check text-[#c0392b]"></i>
                        Admin Dashboard
                    </h1>
                    <p class="text-xs text-gray-400 mt-0.5">Full system control panel</p>
                </div>
                <div class="text-right text-xs text-gray-400">
                    <span id="currentTime"></span>
                </div>
            </div>

            <!-- ── OVERVIEW STATS ── -->
            <section id="section-overview">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">

                    <div
                        class="bg-white border border-gray-200 rounded-2xl p-5 flex flex-col gap-2 hover:-translate-y-1 transition-transform">
                        <div class="text-2xl text-blue-500"><i class="bi bi-people-fill"></i></div>
                        <div class="text-3xl font-bold text-gray-800" id="statUsers">—</div>
                        <div class="text-sm text-gray-500">Total Users</div>
                    </div>

                    <div
                        class="bg-white border border-gray-200 rounded-2xl p-5 flex flex-col gap-2 hover:-translate-y-1 transition-transform">
                        <div class="text-2xl text-green-500"><i class="bi bi-box-seam-fill"></i></div>
                        <div class="text-3xl font-bold text-gray-800" id="statProducts">—</div>
                        <div class="text-sm text-gray-500">Total Products</div>
                    </div>

                    <div
                        class="bg-white border border-gray-200 rounded-2xl p-5 flex flex-col gap-2 hover:-translate-y-1 transition-transform">
                        <div class="text-2xl text-orange-500"><i class="bi bi-bell-fill"></i></div>
                        <div class="text-3xl font-bold text-gray-800" id="statAlerts">—</div>
                        <div class="text-sm text-gray-500">Active Alerts</div>
                    </div>

                    <div
                        class="bg-white border border-gray-200 rounded-2xl p-5 flex flex-col gap-2 hover:-translate-y-1 transition-transform">
                        <div class="text-2xl text-[#c0392b]"><i class="bi bi-search-heart"></i></div>
                        <div class="text-3xl font-bold text-gray-800" id="statSearches">—</div>
                        <div class="text-sm text-gray-500">Total Searches</div>
                    </div>

                </div>
            </section>

            <!-- ── USERS TABLE ── -->
            <section id="section-users" class="bg-white border border-gray-200 rounded-2xl p-5 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-semibold flex items-center gap-2">
                        <i class="bi bi-people text-gray-500"></i> User Management
                    </h3>
                    <button onclick="showNotice('Add User')"
                        class="bg-black text-white text-xs px-4 py-2 rounded-lg font-semibold hover:bg-gray-800 transition-colors">
                        <i class="bi bi-plus-circle me-1"></i> Add User
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-black text-white text-left">
                                <th class="px-3 py-2.5 rounded-tl-lg">#</th>
                                <th class="px-3 py-2.5">Name</th>
                                <th class="px-3 py-2.5 hidden md:table-cell">Email</th>
                                <th class="px-3 py-2.5 hidden sm:table-cell">Joined</th>
                                <th class="px-3 py-2.5">Status</th>
                                <th class="px-3 py-2.5 rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-gray-400 py-8">
                                    <div
                                        class="inline-block w-4 h-4 border-2 border-gray-300 border-t-black rounded-full animate-spin mr-2">
                                    </div>
                                    Loading users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ── PRODUCTS TABLE ── -->
            <section id="section-products" class="bg-white border border-gray-200 rounded-2xl p-5 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-semibold flex items-center gap-2">
                        <i class="bi bi-box-seam text-gray-500"></i> Product Management
                    </h3>
                    <button onclick="showNotice('Add Product')"
                        class="bg-black text-white text-xs px-4 py-2 rounded-lg font-semibold hover:bg-gray-800 transition-colors">
                        <i class="bi bi-plus-circle me-1"></i> Add Product
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-black text-white text-left">
                                <th class="px-3 py-2.5 rounded-tl-lg">#</th>
                                <th class="px-3 py-2.5">Product Name</th>
                                <th class="px-3 py-2.5 hidden md:table-cell">Category</th>
                                <th class="px-3 py-2.5 hidden md:table-cell">Brand</th>
                                <th class="px-3 py-2.5 hidden sm:table-cell">Listings</th>
                                <th class="px-3 py-2.5">Status</th>
                                <th class="px-3 py-2.5 rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr>
                                <td colspan="7" class="text-center text-gray-400 py-8">
                                    <div
                                        class="inline-block w-4 h-4 border-2 border-gray-300 border-t-black rounded-full animate-spin mr-2">
                                    </div>
                                    Loading products...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ── ALERTS TABLE ── -->
            <section id="section-alerts" class="bg-white border border-gray-200 rounded-2xl p-5 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-semibold flex items-center gap-2">
                        <i class="bi bi-bell text-gray-500"></i> Price Alerts
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-black text-white text-left">
                                <th class="px-3 py-2.5 rounded-tl-lg">#</th>
                                <th class="px-3 py-2.5">User</th>
                                <th class="px-3 py-2.5 hidden sm:table-cell">Product</th>
                                <th class="px-3 py-2.5">Target Price</th>
                                <th class="px-3 py-2.5">Status</th>
                                <th class="px-3 py-2.5 rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="alertsTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-gray-400 py-8">
                                    <div
                                        class="inline-block w-4 h-4 border-2 border-gray-300 border-t-black rounded-full animate-spin mr-2">
                                    </div>
                                    Loading alerts...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ── ACTIVITY LOG ── -->
            <section id="section-activity" class="bg-white border border-gray-200 rounded-2xl p-5 mb-6">
                <h3 class="text-base font-semibold flex items-center gap-2 mb-4">
                    <i class="bi bi-clock-history text-gray-500"></i> Recent Activity
                </h3>
                <div id="activityLog"></div>
            </section>

        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8001/api';

        // ── AUTH GUARD ─────────────────────────────────────────────
        if (!localStorage.getItem('authToken')) {
            window.location.href = 'login.html';
        }

        // ── HELPERS ────────────────────────────────────────────────
        async function apiCall(endpoint, options = {}) {
            const t = localStorage.getItem('authToken');
            if (!t) { window.location.href = 'login.html'; return null; }
            const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${t}`,
                    'Content-Type': 'application/json',
                    ...(options.headers || {})
                }
            });
            if (res.status === 401) { localStorage.removeItem('authToken'); window.location.href = 'login.html'; return null; }
            return res;
        }

        function showNotice(action) { alert(`${action}: This feature requires backend integration.`); }

        function badge(status) {
            const map = {
                active: 'bg-green-100 text-green-800',
                inactive: 'bg-red-100 text-red-800',
                pending: 'bg-yellow-100 text-yellow-800',
            };
            return `<span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-semibold ${map[status] || map.active}">${status}</span>`;
        }

        function actionBtns(viewFn, deleteFn) {
            return `
                <button onclick="${viewFn}" class="border border-gray-300 rounded-md px-2 py-1 text-xs hover:bg-black hover:text-white hover:border-black transition-colors">
                    <i class="bi bi-eye"></i>
                </button>
                <button onclick="${deleteFn}" class="border border-gray-300 rounded-md px-2 py-1 text-xs ml-1 hover:bg-[#c0392b] hover:text-white hover:border-[#c0392b] transition-colors">
                    <i class="bi bi-trash"></i>
                </button>
            `;
        }

        function tdClass() { return 'px-3 py-2.5 border-b border-gray-100 text-gray-700 align-middle'; }

        // ── INIT ───────────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', async function () {
            const username = localStorage.getItem('username') || 'Admin';
            document.getElementById('displayUsername').textContent = username;
            document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();

            // Clock
            const updateClock = () => {
                document.getElementById('currentTime').textContent =
                    new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            };
            updateClock();
            setInterval(updateClock, 60000);

            // Mobile sidebar
            const mobileToggle = document.getElementById('mobileToggle');
            const sidebar = document.getElementById('sidebar');
            mobileToggle.addEventListener('click', e => {
                e.stopPropagation();
                sidebar.classList.toggle('active');
                mobileToggle.innerHTML = sidebar.classList.contains('active')
                    ? '<i class="bi bi-x-lg"></i>' : '<i class="bi bi-list"></i>';
            });
            document.addEventListener('click', e => {
                if (window.innerWidth <= 992 && !sidebar.contains(e.target) && !mobileToggle.contains(e.target) && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mobileToggle.innerHTML = '<i class="bi bi-list"></i>';
                }
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', e => {
                e.preventDefault();
                ['authToken', 'user', 'username', 'isAdmin'].forEach(k => localStorage.removeItem(k));
                window.location.href = 'login.html';
            });

            // Nav scroll
            document.querySelectorAll('.nav-item[href^="#"]').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    this.classList.add('active');
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });

            await Promise.all([loadUsers(), loadProducts(), loadAlerts()]);
            renderActivityLog();
        });

        // ── USERS ──────────────────────────────────────────────────
        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            try {
                const res = await apiCall('/admin/users');
                if (res && res.ok) {
                    const users = await res.json();
                    document.getElementById('statUsers').textContent = users.length;
                    tbody.innerHTML = users.map((u, i) => `
                        <tr class="hover:bg-gray-50">
                            <td class="${tdClass()}">${i + 1}</td>
                            <td class="${tdClass()} font-medium">${(u.first_name || '') + ' ' + (u.last_name || '') || u.email.split('@')[0]}</td>
                            <td class="${tdClass()} hidden md:table-cell">${u.email}</td>
                            <td class="${tdClass()} hidden sm:table-cell">${u.created_at ? new Date(u.created_at).toLocaleDateString() : '—'}</td>
                            <td class="${tdClass()}">${badge('active')}</td>
                            <td class="${tdClass()}">${actionBtns("showNotice('View user')", "showNotice('Deactivate user')")}</td>
                        </tr>`).join('');
                } else { renderMockUsers(tbody); }
            } catch { renderMockUsers(tbody); }
        }

        function renderMockUsers(tbody) {
            const mock = [
                { name: 'Alice Johnson', email: 'alice@example.com', joined: '2025-01-10', status: 'active' },
                { name: 'Bob Smith', email: 'bob@example.com', joined: '2025-02-14', status: 'active' },
                { name: 'Carol White', email: 'carol@example.com', joined: '2025-03-01', status: 'inactive' },
            ];
            document.getElementById('statUsers').textContent = mock.length + '+';
            tbody.innerHTML = mock.map((u, i) => `
                <tr class="hover:bg-gray-50">
                    <td class="${tdClass()}">${i + 1}</td>
                    <td class="${tdClass()} font-medium">${u.name}</td>
                    <td class="${tdClass()} hidden md:table-cell">${u.email}</td>
                    <td class="${tdClass()} hidden sm:table-cell">${u.joined}</td>
                    <td class="${tdClass()}">${badge(u.status)}</td>
                    <td class="${tdClass()}">${actionBtns("showNotice('View user')", "showNotice('Deactivate user')")}</td>
                </tr>`).join('');
        }

        // ── PRODUCTS ───────────────────────────────────────────────
        async function loadProducts() {
            const tbody = document.getElementById('productsTableBody');
            try {
                const res = await apiCall('/products?limit=20');
                if (res && res.ok) {
                    const data = await res.json();
                    const products = data.products || data;
                    document.getElementById('statProducts').textContent = products.length;
                    tbody.innerHTML = products.map((p, i) => `
                        <tr class="hover:bg-gray-50">
                            <td class="${tdClass()}">${i + 1}</td>
                            <td class="${tdClass()} font-medium">${p.name}</td>
                            <td class="${tdClass()} hidden md:table-cell">${p.category || '—'}</td>
                            <td class="${tdClass()} hidden md:table-cell">${p.brand || '—'}</td>
                            <td class="${tdClass()} hidden sm:table-cell">${p.listings ? p.listings.length : '—'}</td>
                            <td class="${tdClass()}">${badge('active')}</td>
                            <td class="${tdClass()}">${actionBtns("window.open('productDetails.html?id=" + p.id + "','_blank')", "showNotice('Delete product')")}</td>
                        </tr>`).join('');
                } else { renderMockProducts(tbody); }
            } catch { renderMockProducts(tbody); }
        }

        function renderMockProducts(tbody) {
            const mock = [
                { name: 'iPhone 15 Pro', category: 'Smartphones', brand: 'Apple', listings: 4, status: 'active' },
                { name: 'MacBook Pro M3', category: 'Laptops', brand: 'Apple', listings: 3, status: 'active' },
                { name: 'Samsung Galaxy S24', category: 'Smartphones', brand: 'Samsung', listings: 5, status: 'active' },
                { name: 'Sony WH-1000XM5', category: 'Headphones', brand: 'Sony', listings: 2, status: 'pending' },
            ];
            document.getElementById('statProducts').textContent = mock.length + '+';
            tbody.innerHTML = mock.map((p, i) => `
                <tr class="hover:bg-gray-50">
                    <td class="${tdClass()}">${i + 1}</td>
                    <td class="${tdClass()} font-medium">${p.name}</td>
                    <td class="${tdClass()} hidden md:table-cell">${p.category}</td>
                    <td class="${tdClass()} hidden md:table-cell">${p.brand}</td>
                    <td class="${tdClass()} hidden sm:table-cell">${p.listings}</td>
                    <td class="${tdClass()}">${badge(p.status)}</td>
                    <td class="${tdClass()}">${actionBtns("showNotice('View product')", "showNotice('Delete product')")}</td>
                </tr>`).join('');
        }

        // ── ALERTS ─────────────────────────────────────────────────
        async function loadAlerts() {
            const tbody = document.getElementById('alertsTableBody');
            try {
                const res = await apiCall('/alerts');
                if (res && res.ok) {
                    const alerts = await res.json();
                    document.getElementById('statAlerts').textContent = alerts.length;
                    tbody.innerHTML = alerts.length === 0
                        ? `<tr><td colspan="6" class="text-center text-gray-400 py-8">No active alerts.</td></tr>`
                        : alerts.map((a, i) => `
                            <tr class="hover:bg-gray-50">
                                <td class="${tdClass()}">${i + 1}</td>
                                <td class="${tdClass()}">${a.user_email || 'N/A'}</td>
                                <td class="${tdClass()} hidden sm:table-cell">${a.product_name || '—'}</td>
                                <td class="${tdClass()}">₹${a.target_price?.toLocaleString() || '—'}</td>
                                <td class="${tdClass()}">${badge('active')}</td>
                                <td class="${tdClass()}">
                                    <button onclick="showNotice('Delete alert')" class="border border-gray-300 rounded-md px-2 py-1 text-xs hover:bg-[#c0392b] hover:text-white hover:border-[#c0392b] transition-colors"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>`).join('');
                } else { renderMockAlerts(tbody); }
            } catch { renderMockAlerts(tbody); }
        }

        function renderMockAlerts(tbody) {
            const mock = [
                { user: 'alice@example.com', product: 'iPhone 15 Pro', target: '₹85,000', status: 'active' },
                { user: 'bob@example.com', product: 'MacBook Pro M3', target: '₹1,50,000', status: 'active' },
            ];
            document.getElementById('statAlerts').textContent = mock.length + '+';
            tbody.innerHTML = mock.map((a, i) => `
                <tr class="hover:bg-gray-50">
                    <td class="${tdClass()}">${i + 1}</td>
                    <td class="${tdClass()}">${a.user}</td>
                    <td class="${tdClass()} hidden sm:table-cell">${a.product}</td>
                    <td class="${tdClass()}">${a.target}</td>
                    <td class="${tdClass()}">${badge(a.status)}</td>
                    <td class="${tdClass()}">
                        <button onclick="showNotice('Delete alert')" class="border border-gray-300 rounded-md px-2 py-1 text-xs hover:bg-[#c0392b] hover:text-white hover:border-[#c0392b] transition-colors"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`).join('');
        }

        // ── ACTIVITY LOG ───────────────────────────────────────────
        function renderActivityLog() {
            const logs = [
                { icon: 'bi-person-check', bg: 'bg-green-100', color: 'text-green-700', text: 'New user <strong>alice@example.com</strong> registered', time: '2 mins ago' },
                { icon: 'bi-search', bg: 'bg-blue-100', color: 'text-blue-700', text: 'Product search: <strong>iPhone 15</strong>', time: '5 mins ago' },
                { icon: 'bi-bell', bg: 'bg-yellow-100', color: 'text-yellow-700', text: 'Price alert triggered for <strong>MacBook Pro M3</strong>', time: '15 mins ago' },
                { icon: 'bi-box-seam', bg: 'bg-purple-100', color: 'text-purple-700', text: 'New product listing added: <strong>Galaxy S24</strong>', time: '1 hour ago' },
                { icon: 'bi-arrow-left-right', bg: 'bg-red-100', color: 'text-red-700', text: 'Price comparison completed for <strong>Sony WH-1000XM5</strong>', time: '2 hours ago' },
            ];
            document.getElementById('activityLog').innerHTML = logs.map(l => `
                <div class="flex items-center gap-3 py-3 border-b border-gray-100 last:border-0">
                    <div class="w-9 h-9 flex items-center justify-center rounded-full flex-shrink-0 ${l.bg} ${l.color}">
                        <i class="bi ${l.icon}"></i>
                    </div>
                    <div class="flex-1 text-sm text-gray-700">${l.text}</div>
                    <div class="text-xs text-gray-400 whitespace-nowrap">${l.time}</div>
                </div>`).join('');
            document.getElementById('statSearches').textContent = '24+';
        }
    </script>
</body>

</html>