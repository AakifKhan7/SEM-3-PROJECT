<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Tech Deals Finder</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/dashboard.css">

    <style>
        /* Product Specific Overrides */
        .product-main-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 12px;
        }

        .image-gallery {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .thumbnail:hover {
            border-color: var(--accent-color);
        }

        .product-rating {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .stars {
            color: #ffc107;
        }

        .price-section {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .current-price {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .original-price {
            font-size: 1.25rem;
            text-decoration: line-through;
            color: var(--text-muted);
            margin-left: 10px;
        }

        .discount-badge {
            background-color: #dc3545;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .retailer-card {
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
        }

        .retailer-card:last-child {
            border-bottom: none;
        }

        .specs-table th {
            width: 40%;
            color: var(--text-muted);
            font-weight: 500;
        }
    </style>
</head>

<body>
    <!-- Header Section -->
    <section class="header-section">
        <div class="container">
            <div class="d-flex align-items-center gap-2 mb-3">
                <a href="dashboard.html" class="btn-buy"
                    style="padding: 6px 16px; font-size: 0.9rem; text-decoration: none;">Dashboard</a>
                <a href="#" onclick="history.back()" class="btn-buy"
                    style="padding: 6px 16px; font-size: 0.9rem; text-decoration: none;">Search Results</a>
                <span class="text-dark ms-2" style="font-weight: 500;" id="breadcrumbProductName">Product
                    Details</span>
            </div>
            <h1 class="header-title" id="productPageTitle">Loading Product Details...</h1>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container mb-5">
        <div class="row">
            <!-- Product Image Section -->
            <div class="col-lg-6 mb-4">
                <div class="glass-card p-4">
                    <div class="product-image-container">
                        <img id="productMainImage" src="https://via.placeholder.com/400x400?text=Product+Image"
                            alt="Product" class="product-main-image">
                    </div>
                    <div class="image-gallery" id="imageGallery">
                        <!-- Thumbnails will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Product Info Section -->
            <div class="col-lg-6 mb-4">
                <div class="glass-card p-4">
                    <h2 class="product-title" id="productTitle">Product Name</h2>

                    <div class="product-rating">
                        <div class="stars" id="productRating">
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-half"></i>
                        </div>
                        <span class="rating-text" id="ratingText">4.5 out of 5 (234 reviews)</span>
                    </div>

                    <div class="price-section">
                        <div class="d-flex align-items-center flex-wrap">
                            <span class="current-price" id="currentPrice">$999</span>
                            <span class="original-price" id="originalPrice">$1,299</span>
                            <span class="discount-badge" id="discountBadge">23% OFF</span>
                        </div>
                        <p class="text-dark mb-0 mt-2">
                            <i class="bi bi-tag-fill text-success"></i>
                            Best price available across all retailers
                        </p>
                    </div>

                    <div class="features-section">
                        <h4 class="text-dark mb-3">Key Features</h4>
                        <ul class="feature-list" id="featuresList">
                            <li><i class="bi bi-check-circle-fill"></i> High-quality display with vibrant colors</li>
                            <li><i class="bi bi-check-circle-fill"></i> Powerful processor for smooth performance</li>
                            <li><i class="bi bi-check-circle-fill"></i> Advanced camera system</li>
                            <li><i class="bi bi-check-circle-fill"></i> Long-lasting battery life</li>
                            <li><i class="bi bi-check-circle-fill"></i> Premium build quality</li>
                        </ul>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn-buy" onclick="scrollToRetailers()" style="width: 100%;">
                            <i class="bi bi-shopping-cart"></i> View All Deals
                        </button>
                        <a id="comparePageBtn" href="#" class="btn btn-outline-dark mt-2"
                            style="width: 100%; display: block; text-align: center; text-decoration: none;">
                            <i class="bi bi-arrow-left-right"></i> Compare Prices
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Specifications Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-4">
                    <h3 class="text-dark mb-4">Technical Specifications</h3>
                    <div class="specs-table">
                        <table id="specsTable">
                            <tbody>
                                <tr>
                                    <th>Display</th>
                                    <td id="specDisplay">6.7-inch Super Retina XDR</td>
                                </tr>
                                <tr>
                                    <th>Processor</th>
                                    <td id="specProcessor">A17 Pro chip</td>
                                </tr>
                                <tr>
                                    <th>Storage</th>
                                    <td id="specStorage">128GB / 256GB / 512GB / 1TB</td>
                                </tr>
                                <tr>
                                    <th>Camera</th>
                                    <td id="specCamera">48MP Main + 12MP Ultra Wide + 12MP Telephoto</td>
                                </tr>
                                <tr>
                                    <th>Battery</th>
                                    <td id="specBattery">All-day battery life</td>
                                </tr>
                                <tr>
                                    <th>Connectivity</th>
                                    <td id="specConnectivity">5G, Wi-Fi 6E, Bluetooth 5.3</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Retailer Deals Section -->
        <div class="row" id="retailersSection">
            <div class="col-12">
                <div class="glass-card p-4">
                    <h3 class="text-dark mb-4">
                        <i class="bi bi-shop"></i> Available Deals from Retailers
                    </h3>
                    <div id="retailersList">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000/api';

        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('authToken');
            const defaultHeaders = {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            };

            const config = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            };

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('authToken');
                    window.location.href = 'login.html';
                    return null;
                }
                return response;
            } catch (error) {
                console.error('API Call Error:', error);
                throw error; // Re-throw instead of swallowing as null!
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadProductDetails();
        });

        async function loadProductDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                // If no ID, maybe redirect to search or show error
                document.getElementById('productPageTitle').textContent = 'Product not specified';
                return;
            }

            // Set Compare Button Link
            const compareBtn = document.getElementById('comparePageBtn');
            if (compareBtn) {
                compareBtn.href = `compare.html?product_id=${productId}`;
            }

            try {
                const response = await apiCall(`/products/${productId}`);
                if (response && response.ok) {
                    const product = await response.json();
                    displayProductDetails(product);
                } else {
                    document.getElementById('productPageTitle').textContent = 'Product not found';
                }
            } catch (error) {
                console.error('Error loading product:', error);
                document.getElementById('productPageTitle').textContent = 'Error loading product';
            }
        }

        function displayProductDetails(product) {
            // Basic Info
            document.getElementById('productPageTitle').textContent = product.name;
            document.getElementById('breadcrumbProductName').textContent = product.name;
            document.getElementById('productTitle').textContent = product.name;

            // Image
            const mainImage = document.getElementById('productMainImage');
            mainImage.src = product.image_url || 'https://via.placeholder.com/400x400?text=No+Image';
            mainImage.alt = product.name;

            // Clear gallery (we only have one image for now)
            const gallery = document.getElementById('imageGallery');
            gallery.innerHTML = '';
            // Add main image as thumbnail
            if (product.image_url) {
                const thumbnail = document.createElement('img');
                thumbnail.src = product.image_url;
                thumbnail.className = 'thumbnail';
                thumbnail.onclick = () => mainImage.src = product.image_url;
                gallery.appendChild(thumbnail);
            }

            // Description / Features
            const featuresList = document.getElementById('featuresList');
            featuresList.innerHTML = '';
            if (product.description) {
                const descLines = product.description.split('\n').filter(line => line.trim());
                descLines.forEach(line => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="bi bi-check-circle-fill"></i> ${line}`;
                    featuresList.appendChild(li);
                });
            } else {
                featuresList.innerHTML = '<li>No description available</li>';
            }

            // Specs (we might not have structured specs in basic schema, so use description or placeholders)
            // For now, let's just show category/brand in specs
            document.getElementById('specDisplay').textContent = product.category || 'N/A';
            document.getElementById('specProcessor').textContent = product.brand || 'N/A';
            document.getElementById('specStorage').textContent = 'N/A'; // Not in basic schema

            // Listings / Price
            if (product.listings && product.listings.length > 0) {
                // Find best price
                const prices = product.listings.map(l => l.price);
                const bestPrice = Math.min(...prices);
                const bestListing = product.listings.find(l => l.price === bestPrice);

                document.getElementById('currentPrice').textContent = `₹${bestPrice.toLocaleString()}`;

                if (bestListing.original_price) {
                    document.getElementById('originalPrice').textContent = `₹${bestListing.original_price.toLocaleString()}`;
                } else {
                    document.getElementById('originalPrice').textContent = '';
                }

                if (bestListing.discount_percentage) {
                    document.getElementById('discountBadge').textContent = `${Math.round(bestListing.discount_percentage)}% OFF`;
                    document.getElementById('discountBadge').style.display = 'inline-block';
                } else {
                    document.getElementById('discountBadge').style.display = 'none';
                }

                // Rating (from best listing)
                if (bestListing.rating) {
                    updateRating(bestListing.rating, 0);
                } else {
                    updateRating(0, 0);
                }

                renderRetailers(product.listings);

            } else {
                document.getElementById('currentPrice').textContent = 'Unavailable';
                document.getElementById('originalPrice').textContent = '';
                document.getElementById('discountBadge').style.display = 'none';
                document.getElementById('retailersList').innerHTML = '<p class="text-dark">No active listings found.</p>';
            }
        }

        function renderRetailers(listings) {
            const retailersList = document.getElementById('retailersList');
            retailersList.innerHTML = '';

            listings.forEach(listing => {
                const retailerCard = document.createElement('div');
                retailerCard.className = 'retailer-card';

                // Determine platform name
                let platformName = listing.platform_name;
                if (!platformName) {
                    if (listing.product_url.includes('amazon')) platformName = 'Amazon';
                    else if (listing.product_url.includes('flipkart')) platformName = 'Flipkart';
                    else platformName = 'Unknown Store';
                }

                retailerCard.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-12 col-md-4">
                            <div class="retailer-name">${platformName}</div>
                            <div class="retailer-price">₹${listing.price.toLocaleString()}</div>
                            <div class="retailer-stock ${listing.availability_status === 'out_of_stock' ? 'out-of-stock' : ''}">
                                <i class="bi bi-check-circle-fill"></i> ${listing.availability_status ? listing.availability_status.replace('_', ' ') : 'In Stock'}
                            </div>
                        </div>
                        <div class="col-12 col-md-4 my-2 my-md-0">
                            <div class="text-dark">
                                ${listing.original_price ? `<small>Was: ₹${listing.original_price.toLocaleString()}</small><br>` : ''}
                                ${listing.discount_percentage ? `<strong>${Math.round(listing.discount_percentage)}% OFF</strong>` : ''}
                            </div>
                            <div class="stars mt-1">
                                ${generateStars(listing.rating || 0)}
                                <small class="text-muted">(${listing.rating || 'N/A'})</small>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 text-md-end text-start">
                            <a href="${listing.product_url}" target="_blank" class="btn-buy d-inline-block w-auto">
                                <i class="bi bi-cart-plus"></i> Buy Now
                            </a>
                        </div>
                    </div>
                `;
                retailersList.appendChild(retailerCard);
            });
        }

        function updateRating(rating, reviews) {
            document.getElementById('productRating').innerHTML = generateStars(rating);
            document.getElementById('ratingText').textContent = `${rating} out of 5`;
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0; // approximate
            let starsHTML = '';

            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<i class="bi bi-star-fill text-warning"></i>';
            }
            if (hasHalfStar) { // Simplified logic
                // validation usually needed for 0.5 step
            }
            // Fill rest with empty? Or just show filled. 
            // Logic from before was fine.
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            // ... simplifying for safety in replacement

            return starsHTML + (hasHalfStar ? '<i class="bi bi-star-half text-warning"></i>' : '') + '<i class="bi bi-star text-warning"></i>'.repeat(Math.max(0, 5 - Math.ceil(rating)));
        }

        function scrollToRetailers() {
            document.getElementById('retailersSection').scrollIntoView({
                behavior: 'smooth'
            });
        }

    </script>
</body>

</html>